Private Sub Form_Load()
    ' TESTING VERSION - Shows detailed diagnostics
    Dim userCount As Long
    Dim ldbInfo As String
    Dim isActive As Boolean
    
    ' Get user count
    On Error Resume Next
    userCount = CurrentDb.Properties("UserCount")
    On Error GoTo 0
    
    ' Check detection result
    isActive = IsAnotherUserActive()
    
    ' Build diagnostic message
    ldbInfo = "=== MULTI-USER DETECTION TEST ===" & vbCrLf & vbCrLf
    ldbInfo = ldbInfo & "Current User: " & Environ("USERNAME") & vbCrLf
    ldbInfo = ldbInfo & "Computer: " & Environ("COMPUTERNAME") & vbCrLf
    ldbInfo = ldbInfo & "UserCount Property: " & userCount & vbCrLf
    ldbInfo = ldbInfo & "Another User Active: " & isActive & vbCrLf
    
    ' ALWAYS show this message during testing
    MsgBox ldbInfo, vbInformation, "Database Status"
    
    ' If another user is detected, close the form
    If isActive Then
        MsgBox "Another user is currently working in the database." & vbCrLf & vbCrLf & _
               "To prevent data conflicts, only one user can create orders at a time." & vbCrLf & vbCrLf & _
               "Please try again in a few minutes.", _
               vbExclamation + vbOKOnly, _
               "Database In Use"
        
        DoCmd.Close acForm, Me.Name, acSaveNo
    End If
End Sub

Private Function IsAnotherUserActive() As Boolean
    Dim userCount As Long
    Dim ldbSize As Long
    Dim ldbExists As Boolean
    
    ' Method 1: Check UserCount
    On Error Resume Next
    userCount = CurrentDb.Properties("UserCount")
    
    If Err.Number = 0 And userCount > 1 Then
        Debug.Print "Detection Method: UserCount = " & userCount
        IsAnotherUserActive = True
        Exit Function
    End If
    On Error GoTo 0
    
    ' Method 2: Check LDB file size
    ldbExists = CheckLockFile(ldbSize)
    
    If ldbExists And ldbSize > 100 Then
        Debug.Print "Detection Method: LDB file size = " & ldbSize & " bytes"
        IsAnotherUserActive = True
        Exit Function
    End If
    
    Debug.Print "No other users detected"
    IsAnotherUserActive = False
End Function

Private Function CheckLockFile(ByRef fileSize As Long) As Boolean
    Dim dbPath As String
    Dim ldbPath As String
    Dim fso As Object
    
    On Error Resume Next
    
    dbPath = CurrentDb.Name
    ldbPath = Left(dbPath, Len(dbPath) - 6) & ".ldb"
    
    Set fso = CreateObject("Scripting.FileSystemObject")
    
    If fso.FileExists(ldbPath) Then
        fileSize = fso.GetFile(ldbPath).Size
        CheckLockFile = True
        Debug.Print "LDB file found: " & ldbPath & " (" & fileSize & " bytes)"
    Else
        fileSize = 0
        CheckLockFile = False
        Debug.Print "LDB file not found"
    End If
    
    On Error GoTo 0
End Function
